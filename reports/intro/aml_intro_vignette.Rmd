---
title: "Intro AML Vignette"
author: tkeyes
date: "`r Sys.Date()`"
output: 
  github_document:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, dpi = 300)
```

# Executive Summary 

In this vignette, we read in and preprocess AML data from .fcs files. We also provide the option to make histograms representing the number of cells from each sample and their marker expression values. 

```{r libraries-and-params, message=FALSE, warning=FALSE}
# Libraries
libraries <- 
  c(
    'tidyverse',
    'readxl',
    'ggridges',
    'rlang',
    'ggthemes',
    'foreach',
    'tidytof'
  )

# call libraries
source(here::here("scripts", "setup", "aml_utils.R"))
call_libraries(libraries)

# parameters
set_global_variables(locale = "galaxia")
md_path <- here::here("data-raw", "AML_metadata.xlsx")

# set up aml marker and patient information
marker_setup()
patient_setup()

# globals for running different parts of this vignette
is_sampled <- TRUE
generate_histograms <- FALSE #if yes, will generate many histograms for each marker

```

## Read in metadata

```{r read-metadata}
md <- 
  md_path %>% 
  read_excel() %>% 
  mutate(
    Patient = Patient %>% str_to_lower()
  ) %>% 
  janitor::clean_names(case = "snake")

md %>% 
  write_rds(file = here::here("data", "md.rds"))
```


## Read in single-cell data

### From scratch 

```{r raw-read-single-cell, read-raw-data, eval = FALSE}
# read data from raw .fcs files
aml_data_raw <- 
  RAW_DATA_DIRECTORY %>% 
  tof_read_data(sep = "_")
```


```{r}
# clean the column names and add columns encoding 
# patient, condition, plate, and stimulation 
# (as well as assigning each cell a cell_id)
aml_data_raw <- 
  aml_data_raw %>% 
  mutate(
    plate = 
      str_extract(file_name, pattern = "Plate[:digit:]+") %>% 
      str_to_lower(), 
    patient = 
      str_extract(file_name, pattern = "_([:alnum:]+)") %>% 
      str_sub(start = 2L), 
    stimulation = 
      str_extract(file_name, pattern = "[:space:][[:alpha:][:digit:]]+_") %>% 
      str_sub(start = 2L, end = -2L),
    condition = 
      str_extract(file_name, pattern = "(Dx)|(Rx)") %>%
      replace_na(replace = "healthy") %>% 
      str_to_lower()
  ) %>%
  select(
    -Time_Time, 
    -Event_length_Event_length, 
    -contains("Pd", ignore.case = FALSE), 
    -Center_Center, 
    -Offset_Offset, 
    -Width_Width, 
    -Residual_Residual, 
    -beadst_beadDist, 
  ) %>% 
  rename_with(
    .fn =
      function(x) {
        if_else(
          str_detect(x, "empty") | !str_detect(x, "_"),
          x, 
          str_extract(x, pattern = ".+_") %>% 
            str_sub(end = -2L)
        )
      }
  ) %>% 
  rename(file_name = file) %>% 
  mutate(cell_id = as.character(1:n()))
```



```{r}
# write data to an .rds file
aml_data_raw %>% 
  write_rds(file = file.path(DATA_DIRECTORY, "aml_data_raw.rds"))
```


```{r}
# write subsampled data to an .rds file
aml_data_downsampled <- 
  aml_data_raw %>% 
  tof_downsample_prop(group_cols = file_name, prop_cells = 0.1)

aml_data_downsampled %>% 
  write_rds(file = file.path(DATA_DIRECTORY, "aml_data_raw_downsampled.rds"))
```


### From .rds file

```{r rds-read-single-cell}
data_path <- 
  file.path(
    DATA_DIRECTORY, 
    if_else(!is_sampled, "aml_data_raw.rds", "aml_data_raw_downsampled.rds")
  )

aml_data_raw <- 
  data_path %>% 
  read_rds() 
```


### Compare metadata and single-cell data

```{r compare-patient-names-pre}
print(
  str_glue(
    "Patients in MD but not in single-cell data: \n {my_patients} \n",
    my_patients = 
      str_c(
        setdiff(md$patient, str_to_lower(aml_data_raw$patient)), 
        collapse = " "
      )
  )
)


print(
  str_glue(
    "Patients in single-cell data but not in MD: \n {my_patients} \n",
    my_patients = 
      str_c(
        setdiff(str_to_lower(aml_data_raw$patient), md$patient), 
        collapse = " "
      ) 
  )
)

```

Thus, we can see that several patients in the single-cell data set have to be renamed in order to match the metadata. 

```{r fix-patient-names}
aml_data <- 
  aml_data_raw %>% 
  mutate(
    patient = 
      recode(patient, PASBEE = "pasbbe", PASTRP = "pasrtp") %>% 
      str_to_lower(), 
    plate = factor(plate, levels = str_c("plate", 1:16))
  )
```


And now we check the names again... 
```{r compare-patient-names-post}
print(
  str_glue(
    "Patients in MD but not in single-cell data: \n {my_patients} \n",
    my_patients = 
      str_c(
        setdiff(md$patient, str_to_lower(aml_data$patient)), 
        collapse = " "
      )
  )
)


print(
  str_glue(
    "Patients in single-cell data but not in MD: \n {my_patients} \n",
    my_patients = 
      str_c(
        setdiff(str_to_lower(aml_data$patient), md$patient), 
        collapse = " "
      ) 
  )
)
```

And we can see that there are some patients that included in the metadata that we have no single-cell data for. We also see that we have no metadata for the 4 healthy samples (the names that take the form `bm####`), which is expected. 

### Pre-process

Using the {tidytof} function `tof_preprocess()`, we can easily preprocess the data using several different procedures. 

With arcsinh transformation and removal of added noise: 
```{r preprocess-1}
aml_data_p <- 
  aml_data %>% 
  tof_preprocess()

aml_data_downsampled_p <- 
  aml_data_p %>% 
  filter(cell_id %in% aml_data_downsampled$cell_id)
```

With arcsinh transformation and removal of added noise, plus scaling/centering: 

```{r preprocess-2, eval = FALSE, include = FALSE}
ps_fun <- function(x) { 
  x %>% 
    {asinh(x = ./5)} %>% 
    scale() %>% 
    as.numeric()
}

aml_data_ps <- 
  aml_data %>% 
  tof_preprocess(transform_fun = ps_fun)

aml_data_downsampled_ps <- 
  aml_data_ps %>% 
  filter(cell_id %in% aml_data_downsampled$cell_id)
```



With removal of added noise and rank transformation (similar to "cytoDx"):
```{r preprocess-3}
aml_data_r <-
  aml_data %>%
  tof_preprocess(transform_fun = rank)

aml_data_downsampled_r <- 
  aml_data_r %>% 
  mutate(cell_id = as.character(cell_id)) %>% 
  filter(cell_id %in% aml_data_downsampled$cell_id)
```


We can then save our pre-processed data. In the saved files, 'p' indicates standard preprocessing with the arcsinh transformation, 's' indicates scaling, and 'r' indicates the rank transformation. 

```{r save-preprocessed-data}
ls() %>% 
  str_subset(pattern = "aml_data_(downsampled_)?(p|ps|r)$") %>% 
  walk(
    .f = ~ 
      get(.x) %>% 
      write_rds(file = file.path(DATA_DIRECTORY, str_c(.x, ".rds")))
  )
```


## Data quality and univariate distributions

### By plate

#### Number of cells

```{r cell-number-plate}
aml_data %>% 
  count(plate, sort = TRUE) %>% 
  knitr::kable()
```

```{r cell-number-plate-density}
aml_data %>% 
  count(plate) %>% 
  ggplot(aes(x = n)) + 
  geom_density() + 
  geom_point(aes(x = n, y = 0), size = 3, shape = "|") + 
  scale_x_continuous(
    labels = scales::label_number(accuracy = 1, scale = 1e-6, suffix = "M")
  ) +
  scale_y_continuous() + 
  labs(
    subtitle = "Number of cells on each CyTOF plate", 
    caption = "Hash marks indicate individual plate values", 
    x = "Number of cells", 
    y = "Relative Density"
  )
```

#### Univariate histograms

TO DO 

#### By plate (comparing patients on more than one plate)

```{r, warning = FALSE, message = FALSE}
my_patients <- 
  aml_data %>% 
  count(patient, plate) %>% 
  select(-n) %>% 
  count(patient) %>% 
  filter(n > 1) %>% 
  pull(patient)

# aml_data_p %>% 
#   filter(patient %in% my_patients) %>% 
#   mutate(patient_plate = str_c(patient, plate, sep = "_")) %>% 
#   tof_histogram(channel_var = CD45, group_var = patient_plate, ordered = TRUE) + 
#   labs(y = NULL)
# 
# aml_data_p %>% 
#   filter(patient %in% my_patients) %>% 
#   mutate(patient_plate = str_c(patient, plate, sep = "_")) %>% 
#   tof_histogram(channel_var = pSTAT5, group_var = patient_plate, ordered = TRUE) + 
#   labs(y = NULL)
# 
# aml_data_p %>% 
#   filter(patient %in% my_patients) %>% 
#   mutate(patient_plate = str_c(patient, plate, sep = "_")) %>% 
#   tof_histogram(channel_var = CD34, group_var = patient_plate, ordered = TRUE) + 
#   labs(y = NULL)
# 
# aml_data_p %>% 
#   filter(patient %in% my_patients) %>% 
#   mutate(patient_plate = str_c(patient, plate, sep = "_")) %>% 
#   tof_histogram(channel_var = CD38, group_var = patient_plate, ordered = TRUE) + 
#   labs(y = NULL)
```


### By patient

#### Cell counts

```{r counts-patient}
aml_data %>% 
  count(patient) %>% 
  knitr::kable()
```


```{r cell-number-patient-density}
aml_data %>% 
  count(patient) %>%
  ggplot(aes(x = n)) + 
  geom_density() + 
  geom_point(aes(x = n, y = 0), size = 3, shape = "|") + 
  scale_x_continuous(
    labels = scales::label_number(accuracy = 1, scale = 1e-6, suffix = "M")
  ) +
  scale_y_continuous() + 
  labs(
    subtitle = "Number of cells collected from each patient", 
    caption = "Hash marks indicate individual patient values", 
    x = "Number of cells", 
    y = "Relative Density"
  )
```

#### Univariate histograms

TO DO 

### By patient (comparing patients with both Dx and Rx)

#### Cell counts

```{r}
aml_data %>% 
  filter(patient %in% PAIRED_PATIENTS) %>% 
  count(patient, condition)
```

#### Univariate histograms

TO DO 

### By stimulation (surface)

TO DO 


#### Cell counts

```{r cell-number-stims}
aml_data %>% 
  count(stimulation) %>% 
  knitr::kable()
```


#### Univariate histograms

TO DO 





