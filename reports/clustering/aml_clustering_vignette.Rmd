---
title: "Clustering AML vignette"
author: tkeyes
date: "`r Sys.Date()`"
output: 
  github_document:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, dpi = 300)
```

# Executive Summary

In this vignette, we perform clustering on the AML and ALL datasets using several clustering 
algorithms and interrogate some of their basic properties. 

```{r message=FALSE, warning=FALSE}
# Libraries
libraries <- 
  c(
    "tidyverse", 
    "rlang", 
    "ggthemes", 
    "doParallel", 
    "ggrepel", 
    "FlowSOM", 
    "tidytof"
  )

# Parameters - may need to change on scg machines
source(here::here("scripts", "setup", "aml_utils.R"))
call_libraries(libraries)

set_global_variables(locale = "galaxia")

md_path <- here::here("data-raw", "AML_metadata.xlsx")

ALL_CLASSIFIER_MARKERS <- 
  c(
    "CD34", 
    "CD179a", 
    "CD38", 
    "IgMs", 
    "CD127", 
    "CD19", 
    "CD20", 
    "CD24", 
    "Tdt", 
    "IgMi", 
    "CD179b"
  )

CLUSTER_OUTPUT <- 
  here::here("data", "aml_data_clustered.rds")

# set up aml marker and patient information
marker_setup()
patient_setup()

# globals for running different parts of this vignette
is_sampled <- FALSE

# paths 
healthy_myeloid_path <- here::here("data-raw", "healthy_myeloid")
healthy_B_path <- here::here("data-raw", "healthy_DDPR")

input_aml_path <- 
  here::here(
    "data", 
    if_else(is_sampled, "aml_data_downsampled_p.rds", "aml_data_p.rds")
  )
```

# Set-up

```{r, message = FALSE}
# read in AML data - already processed and arcsinh transformed
aml_data <- 
  input_aml_path %>% 
  read_rds()


# load healthy myeloid and B-cell data
healthy_myeloid_data <- 
  healthy_myeloid_path %>% 
  tof_read_data(sep = "_") %>% 
  tof_preprocess()

```


```{r}
aml_data

healthy_myeloid_data
```


We have to some quick tidying of the healthy data channel names: 

```{r}
my_channels <- 
  healthy_myeloid_data %>% 
  select(contains("_"), -Event_length_length, -`cisplatin_195Pt`) %>% 
  colnames() %>% 
  if_else(
    str_detect(., "empty") | !str_detect(., "_"), 
    ., 
    str_extract(., pattern = ".+_") %>% 
      str_sub(end = -2L)
  )

my_channels <- 
  my_channels[my_channels %in% colnames(aml_data)]

healthy_myeloid_data <- 
  healthy_myeloid_data %>% 
  rename_with(
    .fn =
      function(x) {
        if_else(
          str_detect(x, "empty") | !str_detect(x, "_"),
          x, 
          str_extract(x, pattern = ".+_") %>% 
            str_sub(end = -2L)
        )
      }
  ) %>% 
  select(file, all_of(my_channels)) %>% 
  rename(file_name = file)
```


Then we have to extract some metadata from the file name for each classifier population

```{r}
healthy_myeloid_data <- 
  healthy_myeloid_data %>% 
  mutate(
    population = 
      file_name %>% 
      str_remove(pattern = ".+_") %>% 
      str_remove(pattern = ".fcs")
  )

healthy_myeloid_data
```


# Developmental Classifier

## Build the classifier

```{r}
# mahalanobis clusters 
mahalanobis_clusters <-
  healthy_myeloid_data %>% 
  tof_cluster_ddpr(
    cancer_tibble = aml_data, 
    healthy_cell_labels = healthy_myeloid_data$population, 
    cluster_cols = all_of(CLASSIFIER_MARKERS),
    distance_function = "mahalanobis", 
    num_cores = 12L, 
    parallel_cols = patient,
    return_distances = TRUE
  )

mahalanobis_clusters

# calculate cluster-wise accuracy in healthies
mahalanobis_clusters_healthy <-
  healthy_myeloid_data %>% 
  tof_cluster_ddpr(
    cancer_tibble = healthy_myeloid_data, 
    healthy_cell_labels = healthy_myeloid_data$population, 
    cluster_cols = all_of(CLASSIFIER_MARKERS),
    distance_function = "mahalanobis", 
    num_cores = 6L, 
    parallel_cols = file_name,
    return_distances = TRUE
  )

healthy_myeloid_data %>% 
  bind_cols(mahalanobis_clusters_healthy) %>% 
  group_by(population) %>% 
  summarize(prop_correct = sum(population == mahalanobis_cluster) / n()) %>% 
  arrange(-prop_correct)
```


```{r}
# cosine clusters
cosine_clusters <-
  healthy_myeloid_data %>% 
  tof_cluster_ddpr(
    cancer_tibble = aml_data, 
    healthy_cell_labels = healthy_myeloid_data$population, 
    cluster_cols = all_of(CLASSIFIER_MARKERS),
    distance_function = "cosine", 
    num_cores = 12L, 
    parallel_cols = patient,
    return_distances = TRUE
  )

cosine_clusters

# calculate cluster-wise accuracy in healthies
cosine_clusters_healthy <-
  healthy_myeloid_data %>% 
  tof_cluster_ddpr(
    cancer_tibble = healthy_myeloid_data, 
    healthy_cell_labels = healthy_myeloid_data$population, 
    cluster_cols = all_of(CLASSIFIER_MARKERS),
    distance_function = "cosine", 
    num_cores = 6L, 
    parallel_cols = file_name,
    return_distances = TRUE
  )

healthy_myeloid_data %>% 
  bind_cols(cosine_clusters_healthy) %>% 
  group_by(population) %>% 
  summarize(prop_correct = sum(population == cosine_cluster) / n()) %>% 
  arrange(-prop_correct)
```

pearson clusters

```{r}
# cosine clusters
pearson_clusters <-
  healthy_myeloid_data %>% 
  tof_cluster_ddpr(
    cancer_tibble = aml_data, 
    healthy_cell_labels = healthy_myeloid_data$population, 
    cluster_cols = all_of(CLASSIFIER_MARKERS),
    distance_function = "pearson", 
    num_cores = 12L, 
    parallel_cols = patient,
    return_distances = TRUE
  )

pearson_clusters

# calculate cluster-wise accuracy in healthies
pearson_clusters_healthy <-
  healthy_myeloid_data %>% 
  tof_cluster_ddpr(
    cancer_tibble = healthy_myeloid_data, 
    healthy_cell_labels = healthy_myeloid_data$population, 
    cluster_cols = all_of(CLASSIFIER_MARKERS),
    distance_function = "pearson", 
    num_cores = 6L, 
    parallel_cols = file_name,
    return_distances = TRUE
  )

healthy_myeloid_data %>% 
  bind_cols(pearson_clusters_healthy) %>% 
  group_by(population) %>% 
  summarize(prop_correct = sum(population == pearson_cluster) / n()) %>% 
  arrange(-prop_correct)
```

# Phenograph

```{r}

aml_data_nested <- 
  aml_data %>% 
  group_by(patient) %>% 
  nest() %>% 
  ungroup() %>% 
  mutate(num_cells = map_int(.x = data, .f = nrow))

head(aml_data_nested)
```

```{r}
temp <- 
  aml_data_nested %>% 
  slice_head(n = 2L) %>% 
  mutate(
    phenograph_clusters = 
      map(
        .x = data, 
        .f = tof_cluster_phenograph, 
        cluster_cols = any_of(SURFACE_MARKERS)
      )
  )

temp %>% 
  mutate(num_cells = map_int(data, nrow)) %>%
  select(-num_cells) %>% 
  unnest(cols = c(data, phenograph_clusters)) %>% 
  mutate(phenograph_cluster = str_c(patient, "_", phenograph_cluster)) %>% 
  arrange(as.numeric(cell_id)) %>% 
  count(phenograph_cluster)
```


```{r, eval = FALSE}

start <- Sys.time()
aml_data %>% 
  slice_sample(n = 1000) %>% 
  tof_cluster_phenograph(cluster_cols = all_of(SURFACE_MARKERS))
print(Sys.time() - start)

start <- Sys.time()
aml_data %>% 
  slice_sample(n = 5000) %>% 
  tof_cluster_phenograph(cluster_cols = all_of(SURFACE_MARKERS))
print(Sys.time() - start)

start <- Sys.time()
aml_data %>% 
  slice_sample(n = 10000) %>% 
  tof_cluster_phenograph(cluster_cols = all_of(SURFACE_MARKERS)) 
print(Sys.time() - start)

start <- Sys.time()
aml_data %>% 
  slice_sample(n = 20000) %>% 
  tof_cluster_phenograph(cluster_cols = all_of(SURFACE_MARKERS))
print(Sys.time() - start)

start <- Sys.time()
aml_data %>% 
  slice_sample(n = 40000) %>% 
  tof_cluster_phenograph(cluster_cols = all_of(SURFACE_MARKERS))
print(Sys.time() - start)

start <- Sys.time()
aml_data %>% 
  slice_sample(n = 80000) %>% 
  tof_cluster_phenograph(cluster_cols = all_of(SURFACE_MARKERS))
print(Sys.time() - start)

```


# FlowSOM

```{r}
# clustering with surface markers 
flowsom_cluster_surface <- 
  aml_data %>% 
  tof_cluster_flowsom(
    cluster_cols = any_of(SURFACE_MARKERS), 
    perform_metaclustering = FALSE
  )

flowsom_metacluster_surface <- 
  aml_data %>% 
  tof_cluster_flowsom(cluster_cols = any_of(SURFACE_MARKERS))

# clustering using mahalanobis distances as input to flowsom
flowsom_mahalanobis_clusters <- 
  mahalanobis_clusters %>%
  select(-mahalanobis_cluster) %>% 
  tof_cluster_flowsom(cluster_cols = everything())

# clustering with cosine distances
flowsom_cosine_clusters <- 
  cosine_clusters %>%
  select(-cosine_cluster) %>% 
  tof_cluster_flowsom(cluster_cols = everything())

# clustering with signaling markers
flowsom_signaling_clusters <- 
  aml_data %>% 
  tof_cluster_flowsom(cluster_cols = any_of(SIGNALING_MARKERS))

# clustering with all markers
flowsom_all_marker_clusters <- 
  aml_data %>% 
  tof_cluster_flowsom(cluster_cols = any_of(ALL_MARKERS))

```

Adding clusters to master feature matrices and saving
```{r}
aml_data_clustered <- 
  aml_data %>% 
  mutate(
    flowsom_cluster_surface = flowsom_cluster_surface, 
    flowsom_metacluster_surface = flowsom_metacluster_surface, 
    flowsom_cluster_signaling = flowsom_signaling_clusters, 
    flowsom_cluster_mahalanobis = flowsom_mahalanobis_clusters, 
    flowsom_cluster_cosine = flowsom_cosine_clusters, 
    flowsom_cluster_all_markers = flowsom_all_marker_clusters
  ) %>% 
  bind_cols(mahalanobis_clusters) %>% 
  bind_cols(cosine_clusters) %>% 
  bind_cols(pearson_clusters)

write_rds(
  x = aml_data_clustered, 
  file = 
    CLUSTER_OUTPUT %>% 
    if_else(
      is_sampled, 
      true = str_replace(string = ., pattern = ".rds", replacement = "_sampled.rds"), 
      false = .
    )
)
```


